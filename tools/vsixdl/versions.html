<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>VSCode 扩展历史版本</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./style.css">
</head>

<body>

    <div class="container">
        <h2 id="title">历史版本</h2>

        <div class="card" id="ext-card" style="display:none;">
            <div class="header-row">
                <img class="logo" id="ext-logo" src="" alt="logo"
                    onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22><rect width=%2260%22 height=%2260%22 rx=%228%22 fill=%22%23999%22/><text x=%2230%22 y=%2238%22 text-anchor=%22middle%22 font-size=%2230%22 fill=%22white%22>?</text></svg>'">
                <div>
                    <div class="card-title" id="ext-name"></div>
                    <div class="card-sub" id="ext-publisher"></div>
                    <div class="info-text" id="ext-id"></div>
                </div>
            </div>

            <div class="card-desc" id="ext-desc"></div>

            <div class="info-text">
                <b>上次更新：</b><code><span id="meta-updated"></span></code><br />
                <b>发布日期：</b><code><span id="meta-release"></code></span>
            </div>
        </div>
        <br />
        <div class="card">
            <h3>历史版本</h3>
            <div class="info-text" id="versions-count"></div>

            <table>
                <tbody id="versions-body">
                    <tr>
                        <td colspan="4">正在加载版本信息…</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="info-text" id="status-msg" style="color:red; display:none;"></div>
    </div>

    <script>
        function getQueryExt() {
            const p = new URLSearchParams(location.search);
            const raw = p.get("ext") || "";
            const parts = raw.split(".");
            if (parts.length !== 2) return null;
            return { publisher: parts[0], extension: parts[1] };
        }

        function fmt(t) {
            if (!t) return "-";
            const d = new Date(t);
            return isNaN(d) ? t : d.toLocaleString();
        }

        async function fetchDetail(pub, ext) {
            const body = {
                filters: [
                    {
                        criteria: [
                            { filterType: 7, value: pub + "." + ext },
                            { filterType: 8, value: "Microsoft.VisualStudio.Code" },
                            { filterType: 12, value: "4096" }
                        ],
                        pageNumber: 1,
                        pageSize: 1
                    }
                ],
                flags: 55
            };

            const res = await fetch("https://marketplace.visualstudio.com/_apis/public/gallery/extensionquery", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Accept": "application/json;api-version=3.0-preview.1",
                    "User-Agent": "VSCode",
                    "X-Market-Client-Id": "VSCode"
                },
                body: JSON.stringify(body)
            });

            const data = await res.json();
            return data?.results?.[0]?.extensions?.[0] || null;
        }

        function render(ext) {
            document.getElementById("ext-card").style.display = "block";

            document.getElementById("ext-name").textContent = ext.displayName || ext.extensionName;
            document.getElementById("ext-publisher").textContent =
                "开发者：" + (ext.publisher.displayName || ext.publisher.publisherName);
            document.getElementById("ext-id").textContent = ext.publisher.publisherName + "." + ext.extensionName;
            document.getElementById("ext-desc").textContent = ext.shortDescription || "";
            document.getElementById("meta-updated").textContent = fmt(ext.lastUpdated);
            document.getElementById("meta-release").textContent = fmt(ext.releaseDate);

            let logo = "";
            if (ext.versions[0]?.files) {
                const f = ext.versions[0].files.find(x => x.assetType === "Microsoft.VisualStudio.Services.Icons.Default");
                if (f) logo = f.source;
            }
            if (logo) document.getElementById("ext-logo").src = logo;

            const tbody = document.getElementById("versions-body");
            tbody.innerHTML = "";
            const versions = ext.versions.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));

            document.getElementById("versions-count").textContent = `共 ${versions.length} 个版本`;

            versions.forEach(v => {
                const tr = document.createElement("tr");

                const vsix = (v.files || []).find(f => f.assetType === "Microsoft.VisualStudio.Services.VSIXPackage");

                tr.innerHTML = `
        <td>
          ${vsix
                        ? `<a class="download-btn" href="${vsix.source}" download="${ext.publisher.publisherName}.${ext.extensionName}-${v.version}.vsix">下载</a>`
                        : `<span class="download-btn disabled">无文件</span>`
                    }
        </td>
        <td><span class="version-badge">${v.version}</span></td>
        <td>${fmt(v.lastUpdated)}</td>
      `;

                tbody.appendChild(tr);
            });
        }

        async function init() {
            const info = getQueryExt();
            if (!info) {
                document.getElementById("status-msg").textContent = "URL 必须为 ?ext=publisher.extension";
                document.getElementById("status-msg").style.display = "block";
                return;
            }

            try {
                const ext = await fetchDetail(info.publisher, info.extension);
                if (!ext) throw new Error("未找到扩展");

                render(ext);

            } catch (e) {
                document.getElementById("status-msg").textContent = e.message;
                document.getElementById("status-msg").style.display = "block";
            }
        }

        init();
    </script>

</body>

</html>